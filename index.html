<script>
    const socket = io();
    let gameActive = false, canMove = false;
    // shipCoords нужен для системы "авто-промаха" вокруг убитого
    let myShipsMap = Array(100).fill(null), shipsHealth = {}, shipCoords = {};
    let currentSize = 4, isVertical = false;
    let shipLimits = { 4:1, 3:2, 2:3, 1:4 }, currentPlaced = { 4:0, 3:0, 2:0, 1:0 };

    const myGrid = document.getElementById('my-grid'), 
          enemyGrid = document.getElementById('enemy-grid'), 
          status = document.getElementById('status-text');

    // Генерация сеток
    for (let i = 0; i < 100; i++) {
        const mCell = document.createElement('div');
        mCell.className = 'cell'; mCell.id = `my-${i}`;
        mCell.onclick = () => placeShip(i);
        mCell.onmouseenter = () => drawPreview(i, true);
        mCell.onmouseleave = () => drawPreview(i, false);
        myGrid.appendChild(mCell);

        const eCell = document.createElement('div');
        eCell.className = 'cell'; eCell.id = `enemy-${i}`;
        eCell.onclick = () => fire(i);
        enemyGrid.appendChild(eCell);
    }

    function startMultiplayer() {
        const r = document.getElementById('room-id').value, p = document.getElementById('room-pass').value;
        if(!r || !p) return alert("Введите ID и пароль");
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        socket.emit('joinCustomRoom', { room: r, pass: p });
    }

    function selectType(s) {
        currentSize = s;
        document.querySelectorAll('#factory .btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-size-${s}`);
        if(btn) btn.classList.add('active');
    }

    function toggleRotate() { isVertical = !isVertical; }

    function getIndices(idx, size, vert) {
        let res = [], r = Math.floor(idx/10), c = idx%10;
        for(let i=0; i<size; i++) {
            let nr = vert ? r+i : r, nc = vert ? c : c+i;
            if(nr > 9 || nc > 9) return null;
            res.push(nr*10 + nc);
        }
        for(let sIdx of res) {
            let nr = Math.floor(sIdx/10), nc = sIdx%10;
            for(let dr=-1; dr<=1; dr++) {
                for(let dc=-1; dc<=1; dc++) {
                    let row = nr + dr, col = nc + dc;
                    if(row >= 0 && row <= 9 && col >= 0 && col <= 9) {
                        if(myShipsMap[row * 10 + col]) return null;
                    }
                }
            }
        }
        return res;
    }

    function drawPreview(idx, show) {
        if(gameActive) return;
        let coords = getIndices(idx, currentSize, isVertical);
        if(coords) coords.forEach(i => document.getElementById(`my-${i}`).classList.toggle('preview', show));
    }

    function placeShip(idx) {
        if(gameActive || currentPlaced[currentSize] >= shipLimits[currentSize]) return;
        let coords = getIndices(idx, currentSize, isVertical);
        if(!coords) return;

        const sId = `ship-${currentSize}-${idx}`;
        shipsHealth[sId] = currentSize;
        shipCoords[sId] = coords;
        
        coords.forEach(i => { 
            myShipsMap[i] = sId; 
            document.getElementById(`my-${i}`).classList.add('ship'); 
        });

        currentPlaced[currentSize]++;
        
        // ИСПРАВЛЕНО: Добавлен массив [4,3,2,1] перед .find
        if(currentPlaced[currentSize] >= shipLimits[currentSize]) {
            document.getElementById(`btn-size-${currentSize}`).disabled = true;
            let nextSize = [4,3,2,1].find(s => currentPlaced[s] < shipLimits[s]);
            if(nextSize) selectType(nextSize);
        }

        if(Object.values(currentPlaced).reduce((a,b)=>a+b, 0) === 10) {
            document.getElementById('start-btn').disabled = false;
        }
    }

    // Автоматическая пометка клеток вокруг убитого корабля
    function markAround(coords, gridPrefix) {
        coords.forEach(idx => {
            let r = Math.floor(idx/10), c = idx%10;
            for(let dr=-1; dr<=1; dr++) {
                for(let dc=-1; dc<=1; dc++) {
                    let nr = r + dr, nc = c + dc;
                    if(nr >= 0 && nr <= 9 && nc >= 0 && nc <= 9) {
                        let nIdx = nr * 10 + nc;
                        let cell = document.getElementById(`${gridPrefix}-${nIdx}`);
                        if(!cell.classList.contains('hit')) cell.classList.add('miss');
                    }
                }
            }
        });
    }

    function readyToBattle() {
        document.getElementById('factory').classList.add('hidden');
        document.getElementById('start-btn').classList.add('hidden');
        socket.emit('playerReady');
    }

    function fire(idx) {
        if (!gameActive || !canMove) return;
        const cell = document.getElementById(`enemy-${idx}`);
        if (cell.classList.contains('hit') || cell.classList.contains('miss')) return;
        socket.emit('makeMove', { index: idx });
        canMove = false;
    }

    // СЕТЕВАЯ ЛОГИКА
    socket.on('waiting', msg => status.innerText = msg);

    socket.on('gameStart', data => {
        gameActive = true; 
        canMove = data.canMove;
        document.getElementById('enemy-box').classList.remove('hidden');
        status.innerText = canMove ? "ВАШ ХОД!" : "ХОД ВРАГА...";
    });

    socket.on('enemyMove', data => {
        const sId = myShipsMap[data.index];
        if (sId) {
            document.getElementById(`my-${data.index}`).classList.add('hit');
            shipsHealth[sId]--;
            const isKilled = shipsHealth[sId] === 0;
            
            if(isKilled) markAround(shipCoords[sId], 'my');

            if (Object.values(shipsHealth).every(h => h <= 0)) {
                alert("ПОРАЖЕНИЕ!");
                location.reload();
            }

            socket.emit('shotResult', { 
                index: data.index, 
                hit: true, 
                killed: isKilled, 
                coords: isKilled ? shipCoords[sId] : null 
            });
            status.innerHTML = isKilled ? `<span style="color:var(--neon-red)">КОРАБЛЬ УБИТ!</span>` : "ПОПАДАНИЕ!";
        } else {
            document.getElementById(`my-${data.index}`).classList.add('miss');
            socket.emit('shotResult', { index: data.index, hit: false });
            canMove = true;
            status.innerText = "ПРОМАХ! ВАШ ХОД";
        }
    });

    socket.on('updateResult', data => {
        const cell = document.getElementById(`enemy-${data.index}`);
        cell.classList.add(data.hit ? 'hit' : 'miss');
        canMove = data.hit;
        if(data.hit) {
            if(data.killed) {
                markAround(data.coords, 'enemy');
                status.innerHTML = `<span style="color:#00ff00">УБИТ! СТРЕЛЯЙТЕ СНОВА</span>`;
            } else {
                status.innerText = "ПОПАДАНИЕ! ВАШ ХОД";
            }
        } else {
            status.innerText = "МИМО. ХОД ВРАГА";
        }
    });

    socket.on('enemyDisconnected', () => { alert("Враг покинул игру"); location.reload(); });
    socket.on('errorMsg', msg => alert(msg));

    window.onkeydown = (e) => { if(e.key.toLowerCase() === 'r') toggleRotate(); };
</script>
