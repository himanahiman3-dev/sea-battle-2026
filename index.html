<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Sea Battle Neon 2026</title>
    <link href="fonts.googleapis.com" rel="stylesheet">
    <style>
        :root { --neon-blue: #00f2ff; --neon-red: #ff0055; --bg-dark: #020b1a; }
        body { background: var(--bg-dark); color: var(--neon-blue); font-family: 'Orbitron', sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; min-height: 100vh; overflow-x: hidden; }
        
        /* –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ */
        #main-menu { display: flex; flex-direction: column; gap: 20px; padding-top: 50px; text-align: center; }
        .menu-card { background: rgba(0, 242, 255, 0.05); padding: 25px; border: 2px solid var(--neon-blue); width: 350px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.1); }
        .hidden { display: none !important; }

        /* –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù */
        #game-screen { width: 100%; display: flex; flex-direction: column; align-items: center; }
        .game-container { display: flex; gap: 40px; padding: 20px; flex-wrap: wrap; justify-content: center; }
        .grid { display: grid; grid-template-columns: repeat(10, 40px); grid-template-rows: repeat(10, 40px); gap: 2px; background: rgba(0, 242, 255, 0.1); border: 3px solid var(--neon-blue); }
        .cell { width: 40px; height: 40px; background: rgba(2, 11, 26, 0.8); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; }
        
        /* –°–û–°–¢–û–Ø–ù–ò–Ø –ö–õ–ï–¢–û–ö */
        .ship { background: var(--neon-blue) !important; box-shadow: inset 0 0 10px #000; }
        .hit { background: rgba(255, 0, 85, 0.3) !important; animation: shake 0.2s; }
        .hit::after { content: "üí•"; }
        .miss::after { content: "‚Ä¢"; color: var(--neon-blue); font-size: 30px; }
        .preview { background: rgba(0, 242, 255, 0.3) !important; }

        /* –ö–ù–û–ü–ö–ò –ò –ò–ù–ü–£–¢–´ */
        .btn { padding: 12px; background: none; border: 2px solid var(--neon-blue); color: var(--neon-blue); font-family: 'Orbitron'; cursor: pointer; transition: 0.3s; width: 100%; margin: 5px 0; text-transform: uppercase; }
        .btn:hover:not(:disabled) { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }
        .btn.active { background: var(--neon-blue); color: #000; }
        .btn:disabled { border-color: #444; color: #444; cursor: not-allowed; }
        input { background: #000; border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 12px; font-family: 'Orbitron'; width: 90%; margin-bottom: 10px; text-align: center; }
        
        #status-text { height: 70px; font-size: 1.3rem; text-align: center; margin-top: 20px; color: #fff; text-shadow: 0 0 10px var(--neon-blue); }
        .ship-controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .kill-msg { color: var(--neon-red); font-weight: bold; }
    </style>
</head>
<body>

    <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
    <div id="main-menu">
        <h1>SEA BATTLE <span style="color:var(--neon-red)">NEON</span></h1>
        <div class="menu-card">
            <h3>–ú–£–õ–¨–¢–ò–ü–õ–ï–ï–†</h3>
            <input type="text" id="room-id" placeholder="ID –ö–û–ú–ù–ê–¢–´">
            <input type="password" id="room-pass" placeholder="–ü–ê–†–û–õ–¨">
            <button class="btn" onclick="startMultiplayer()">–°–û–ó–î–ê–¢–¨ / –í–û–ô–¢–ò</button>
        </div>
        <div class="menu-card">
            <h3>–û–î–ò–ù–û–ß–ù–ê–Ø –ò–ì–†–ê</h3>
            <button class="btn" onclick="startAI('easy')">–õ–ï–ì–ö–ò–ô –ò–ò</button>
            <button class="btn" onclick="startAI('hard')">–°–õ–û–ñ–ù–´–ô –ò–ò</button>
        </div>
    </div>

    <!-- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù -->
    <div id="game-screen" class="hidden">
        <div id="status-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <div class="ship-controls" id="factory">
            <button class="btn" style="width: 50px;" id="size-4" onclick="selectType(4)">4</button>
            <button class="btn" style="width: 50px;" onclick="selectType(3)">3</button>
            <button class="btn" style="width: 50px;" onclick="selectType(2)">2</button>
            <button class="btn" style="width: 50px;" onclick="selectType(1)">1</button>
            <button class="btn" onclick="toggleRotate()">–ü–û–í–û–†–û–¢ (R)</button>
        </div>

        <div class="game-container">
            <div>
                <p style="text-align: center;">–í–ê–® –§–õ–û–¢</p>
                <div id="my-grid" class="grid"></div>
                <button id="start-btn" class="btn" style="margin-top: 15px;" disabled onclick="readyToBattle()">–í –ë–û–ô!</button>
            </div>
            <div id="enemy-box" class="hidden">
                <p style="text-align: center;">–†–ê–î–ê–† –í–†–ê–ì–ê</p>
                <div id="enemy-grid" class="grid"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const sounds = { 
            bg: new Audio('bg_music.mp3'), 
            shot: new Audio('shot.mp3'), 
            hit: new Audio('hit.mp3'), 
            miss: new Audio('miss.mp3') 
        };
        sounds.bg.loop = true;

        let isAI = false;
        let aiLevel = 'easy';
        let gameActive = false;
        let canMove = false;
        let myShipsMap = Array(100).fill(null);
        let myShipsHealth = {};
        let enemyShipsMap = Array(100).fill(null); 
        let enemyShipsHealth = {};
        
        let currentSize = 4;
        let isVertical = false;
        let shipLimits = { 4:1, 3:2, 2:3, 1:4 };
        let currentPlaced = { 4:0, 3:0, 2:0, 1:0 };
        let playerHits = 0, enemyHits = 0;
        const WIN_SCORE = 20;

        const myGrid = document.getElementById('my-grid');
        const enemyGrid = document.getElementById('enemy-grid');
        const status = document.getElementById('status-text');

        for (let i = 0; i < 100; i++) {
            const mCell = document.createElement('div');
            mCell.className = 'cell';
            mCell.id = `my-${i}`;
            mCell.onclick = () => placeShip(i);
            mCell.onmouseenter = () => drawPreview(i, true);
            mCell.onmouseleave = () => drawPreview(i, false);
            myGrid.appendChild(mCell);

            const eCell = document.createElement('div');
            eCell.className = 'cell';
            eCell.id = `enemy-${i}`;
            eCell.onclick = () => fire(i);
            enemyGrid.appendChild(eCell);
        }

        function startMultiplayer() {
            const room = document.getElementById('room-id').value;
            const pass = document.getElementById('room-pass').value;
            if(!room || !pass) return alert("–í–≤–µ–¥–∏—Ç–µ ID –∏ –ø–∞—Ä–æ–ª—å");
            isAI = false;
            socket.emit('joinCustomRoom', { room, pass });
            enterGame();
        }

        function startAI(level) {
            isAI = true;
            aiLevel = level;
            enterGame();
            generateAIField();
            status.innerText = "–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π —Ñ–ª–æ—Ç";
        }

        function enterGame() {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            sounds.bg.play().catch(()=>{});
        }

        // --- –†–ê–°–°–¢–ê–ù–û–í–ö–ê –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ ---
        function selectType(s) { currentSize = s; }
        function toggleRotate() { isVertical = !isVertical; }

        function drawPreview(idx, show) {
            if (gameActive) return;
            let coords = getIndices(idx, currentSize, isVertical);
            if (coords) coords.forEach(i => {
                const cell = document.getElementById(`my-${i}`);
                if(cell) cell.classList.toggle('preview', show);
            });
        }
        
        function getIndices(idx, size, vert) {
            let res = [], r = Math.floor(idx/10), c = idx%10;
            for(let i=0; i<size; i++) {
                let nr = vert ? r+i : r, nc = vert ? c : c+i;
                if(nr>9 || nc>9) return null;
                res.push(nr*10 + nc);
            }
            return res;
        }

        // --- –†–ê–°–°–¢–ê–ù–û–í–ö–ê –ò–ì–†–û–ö–ê ---
        function placeShip(idx) {
            if (gameActive || currentPlaced[currentSize] >= shipLimits[currentSize]) return;
            let coords = getIndices(idx, currentSize, isVertical);
            if (!coords || coords.some(i => myShipsMap[i])) return;

            let id = `s-${Date.now()}`;
            myShipsHealth[id] = currentSize;
            coords.forEach(i => {
                myShipsMap[i] = { id, size: currentSize };
                document.getElementById(`my-${i}`).classList.add('ship');
            });
            currentPlaced[currentSize]++;
            sounds.shot.play();
            checkReady();
        }

        function checkReady() {
            let total = Object.values(currentPlaced).reduce((a,b)=>a+b, 0);
            if (total === 10) document.getElementById('start-btn').disabled = false;
            status.innerText = `–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ—Ä–∞–ª–µ–π: ${total}/10`;
        }

        function readyToBattle() {
            if (isAI) {
                gameActive = true;
                canMove = true;
                document.getElementById('enemy-box').classList.remove('hidden');
                document.getElementById('factory').classList.add('hidden');
                document.getElementById('start-btn').classList.add('hidden');
                status.innerText = "–í–ê–® –•–û–î";
            } else {
                socket.emit('playerReady');
                document.getElementById('start-btn').innerText = "–û–ñ–ò–î–ê–ù–ò–ï –í–†–ê–ì–ê...";
                document.getElementById('start-btn').disabled = true;
            }
        }

        // --- –ë–û–ô ---
        function fire(idx) {
            if (!gameActive || !canMove) return;
            const cell = document.getElementById(`enemy-${idx}`);
            if (cell.classList.contains('hit') || cell.classList.contains('miss')) return;

            sounds.shot.currentTime = 0;
            sounds.shot.play();

            if (isAI) {
                handleAIShot(idx);
            } else {
                canMove = false;
                socket.emit('makeMove', { index: idx });
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ò ---
        function generateAIField() {
            // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –º–∞—Å—Å–∏–≤ —Ä–∞–∑–º–µ—Ä–æ–≤ –∫–æ—Ä–∞–±–ª–µ–π –¥–ª—è –ò–ò
            let shipSizes = [4, 3, 3, 2, 2, 2, 1, 1, 1, 1];
            let idCounter = 0;

            for (const size of shipSizes) {
                let placed = false;
                while (!placed) {
                    let vertical = Math.random() > 0.5;
                    let startIdx = Math.floor(Math.random() * 100);
                    let coords = getIndices(startIdx, size, vertical);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ—Ä–∞–±–ª—å –ø–æ–º–µ—â–∞–µ—Ç—Å—è –∏ –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è
                    if (coords && !coords.some(i => enemyShipsMap[i])) {
                        const id = `ai-${idCounter++}`;
                        enemyShipsHealth[id] = size;
                        coords.forEach(i => {
                            enemyShipsMap[i] = { id, size };
                        });
                        placed = true;
                    }
                }
            }
        }

        function handleAIShot(idx) {
            const cell = document.getElementById(`enemy-${idx}`);
            const shipData = enemyShipsMap[idx];
            let killedSize = 0;

            if (shipData) {
                cell.classList.add('hit');
                sounds.hit.play();
                enemyShipsHealth[shipData.id]--;
                if (enemyShipsHealth[shipData.id] === 0) killedSize = shipData.size;
                playerHits++;
                if (killedSize > 0) {
                     status.innerHTML = `<span class="kill-msg">–£–ë–ò–¢ ${killedSize}-–ü–ê–õ–£–ë–ù–´–ô!</span>`;
                }
                if (playerHits === WIN_SCORE) { status.innerText = "–ü–û–ë–ï–î–ê!"; gameActive = false; }
            } else {
                cell.classList.add('miss');
                sounds.miss.play();
                canMove = false;
                status.innerText = "–•–û–î –ò–ò...";
                setTimeout(aiMove, 1000);
            }
        }

        function aiMove() {
            if (!gameActive) return;
            let idx = Math.floor(Math.random()*100);
            let cell = document.getElementById(`my-${idx}`);
            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –ò–ò –Ω–µ —Å—Ç—Ä–µ–ª—è–ª –¥–≤–∞–∂–¥—ã –≤ –æ–¥–Ω–æ –º–µ—Å—Ç–æ
            if(cell.classList.contains('hit') || cell.classList.contains('miss')) return aiMove();

            if (myShipsMap[idx]) {
                cell.classList.add('hit');
                sounds.hit.play();
                enemyHits++;
                if (enemyHits === WIN_SCORE) { status.innerText = "–ü–û–†–ê–ñ–ï–ù–ò–ï!"; gameActive = false; }
                else setTimeout(aiMove, 1000); // –ò–ò —Ö–æ–¥–∏—Ç –µ—â–µ —Ä–∞–∑, –µ—Å–ª–∏ –ø–æ–ø–∞–ª
            } else {
                cell.classList.add('miss');
                sounds.miss.play();
                canMove = true;
                status.innerText = "–í–ê–® –•–û–î";
            }
        }

        // --- –°–ï–¢–¨ ---
        socket.on('waiting', (msg) => { status.innerText = msg; });
        socket.on('errorMsg', (msg) => { alert(msg); location.reload(); });
        socket.on('enemyDisconnected', () => {
            alert("–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –±–æ–π. –í—ã –ø–æ–±–µ–¥–∏–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏!");
            location.reload();
        });

        socket.on('gameStart', (data) => {
            gameActive = true;
            canMove = data.canMove;
            document.getElementById('enemy-box').classList.remove('hidden');
            document.getElementById('factory').classList.add('hidden');
            document.getElementById('start-btn').classList.add('hidden');
            status.innerText = canMove ? "–í–ê–® –•–û–î" : "–•–û–î –ü–†–û–¢–ò–í–ù–ò–ö–ê";
        });

        socket.on('enemyMove', (data) => {
            const cell = document.getElementById(`my-${data.index}`);
            const ship = myShipsMap[data.index];
            const isHit = !!ship;
            cell.classList.add(isHit ? 'hit' : 'miss');
            if (isHit) {
                sounds.hit.play();
                enemyHits++;
                if(enemyHits === WIN_SCORE) status.innerText = "–í–´ –ü–†–û–ò–ì–†–ê–õ–ò";
            } else {
                sounds.miss.play();
                canMove = true;
                status.innerText = "–í–ê–® –•–û–î";
            }
            socket.emit('shotResult', { index: data.index, isHit });
        });

        socket.on('updateResult', (data) => {
            const cell = document.getElementById(`enemy-${data.index}`);
            cell.classList.add(data.isHit ? 'hit' : 'miss');
            if (data.isHit) {
                sounds.hit.play();
                playerHits++;
                canMove = true;
                status.innerText = playerHits === WIN_SCORE ? "–ü–û–ë–ï–î–ê!" : "–ü–û–ü–ê–î–ê–ù–ò–ï! –í–∞—à —Ö–æ–¥";
            } else {
                sounds.miss.play();
                canMove = false;
                status.innerText = "–ü–†–û–ú–ê–•! –•–æ–¥ –≤—Ä–∞–≥–∞";
            }
        });
    </script>
</body>
</html>
